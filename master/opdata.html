{{define "opdata"}}
{{$drawID := .ID}}
<html lang="en">
<head>
<title>{{.Name}} Op data</title>
{{template "styles"}}
</head>
<body>
{{template "nav"}}
	<div class="content-sction-a">
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<div class="content-section-a">
<!-- content starts here -->
<h1>Op Data</h1>
<div class="content-area">

<div class="card mb-2">
<div class="card-header">Details</div>
<div class="card-body">
<ul class="list-group list-group-flush">
<li class="list-group-item"><strong>Name:</strong> {{.Name}} (id: {{.ID}})</li>
<li class="list-group-item"><a href="{{WebAPIPath}}/draw/{{.ID}}/perms">Permissions</a></li>
<li class="list-group-item"><a href="{{WebAPIPath}}/draw/{{.ID}}/stock">Stock Intel Link</a></li>
<li class="list-group-item"><a href="{{WebAPIPath}}/draw/{{.ID}}?lite=y">User View</a></li>
<li class="list-group-item"><textarea onChange="setopinfo({{.ID}}, this)">{{.Comment}}</textarea></a></li>
</ul>
</div>
</div>

<div class="card">
<div class="card-header">Links</div>
<div class="card-body">
 <table>
  <thead>
    <tr>
     <td>&nbsp;</td>
     <td>Order</td>
     <td>From</td>
     <td></td>
     <td>To</td>
     <td>Distance</td>
     <td>Assigned To</td>
     <td>Color</td>
     <td>Description</td>
     <td>Completed</td>
   </tr>
  </thead>
  <tbody id="linklist">
{{range .Links}}
  <tr id="{{.ID}}" data-id="{{.ID}}">
     <td><span class="handle"><img src="/static/img/reorder.svg" alt="reorder" style="width=:20px;height:20px;text-align:center;"></span></form></td>
     <td><span id="throworder-{{.ID}}">{{.ThrowOrder}}</span></form></td>
     <td><span id="rev-{{.ID}}-fm"><a href="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/portal/{{.FromID}}">{{.From}}</a></span></td>
     <td>&nbsp;<a href="#"><img src="/static/img/swap.svg" alt="reverse direction" style="width=:20px;height:20px;text-align:center;" onClick="changeLinkDirection({{.ID}}, this)"></a>&nbsp;</td>
     <td><span id="rev-{{.ID}}-to"><a href="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/portal/{{.ToID}}">{{.To}}</a></span></td>
     <td>{{.Distance}}km (level: {{printf "%.1f" .MinPortalLevel}}) </td>
     <td><form action="#">{{OpUserMenu .AssignedToID $drawID .ID "agentAssignLink"}}</form></td>
     <td><form action="#">{{OpColorMenu .Color .ID "colorAssignLink"}}</form></td>
     <td><form action="#"><input type="text" name="desc" value="{{.Desc}}" onChange="assignLinkDesc({{.ID}}, this)"></form></td>
     <td>{{if .Completed}} <img src="/static/img/checkmark.png" alt="completed"> {{end}}</td>
  </tr>
{{end}}
 </tbody>
 </table>
</div>
</div>


<div class="card mb-2">
<div class="card-header">Markers</div>
<div class="card-body">
  <table class="table">
   <thead>
    <tr>
     <th scope="col">&nbsp;</th>
     <th scope="col">Order</th>
     <th scope="col">Portal</th>
     <th scope="col">Type</th>
     <th scope="col">Assigned To</th>
     <th scope="col">Comment</th>
     <th scope="col">Status</th>
    </tr>
   </thead>
   <tbody id="markerlist">
	{{range .Markers}}
		<tr id="{{.ID}}" data-id="{{.ID}}">
                <td><span class="handle"><img src="/static/img/reorder.svg" alt="reorder" style="width=:20px;height:20px;text-align:center;"></span></form></td>
		<td><span id="markerorder-{{.ID}}">{{.Order}}</span></td>
		<td><a href="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/portal/{{.PortalID}}">{{.Portal}}</a></td>
		<td><div class="{{.Type}}">{{.Type}}</div></td>
		<td><form action="#">{{OpUserMenu .AssignedToID $drawID .ID "agentAssignMarker"}}</form></td>
		<td><form action="#"><input type="text" name="comment" value="{{.Comment}}" onChange="assignMarkerComment({{.ID}}, this)"></form></td>
		<td> {{.State}} </td>
		</tr>
	{{end}}
   </tbody>
  </table>
</div>
</div>

<div class="card mb-2">
<div class="card-header" id="keysneeded">Keys Needed</div>
<div class="card-body">
  <table class="table">
   <thead>
    <tr>
     <th scope="col">Portal</th>
     <th scope="col">Keys Required</th>
     <th scope="col">On Hand</th>
    </tr>
   </thead>
   <tbody>
	{{range .Keys}}
		<tr>
		<td><a href="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/portal/{{.ID}}">{{.Portal}}</a></td>
		<td>{{.Required}}</td>
		<td>{{.Onhand}}</form></td>
		</tr>
		{{range .OnhandList}}
		<tr>
		<td></td>
		<td><a href="{{WebAPIPath}}/agent/{{.Gid}}" class="agent-name">{{.Agent}}</a></td>
		<td>{{.Onhand}}</form></td>
		</tr>
		{{end}}
	{{end}}
   </tbody>
  </table>
</div>
</div>

<div class="card mb-2">
<div class="card-header" id="capsulebuildlist">Capsule Build List</div>
<div class="card-body">
  <table class="table">
   <thead>
    <tr>
     <th scope="col">Agent</th>
     <th scope="col">Portal</th>
     <th scope="col">Keys Required</th>
    </tr>
   </thead>
   <tbody>
   {{range .Capsules}}
   <tr>
     <td><a href="{{WebAPIPath}}/agent/{{.Gid}}" class="agent-name">{{.Agent}}</a></td>
     <td><a href="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/portal/{{.ID}}">{{.Portal}}</a></td>
     <td>{{.Required}}</td>
   </tr>
   {{end}}
   </tbody>
  </table>
</div>
</div>

<div class="card mb-2">
<div class="card-header">Misc. Functions</div>
<div class="card-body">
  <table class="table">
   <tbody>
     <tr><td><form action="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/chown"><input type="text" name="to" value=""> <input type="submit" name="Change Owner" value="Change Owner"></form></td></tr>
   </tbody>
  </table>
</div>
</div>

</div>
		<!-- content ends here -->				
					</div>
				</div>
			</div>
		</div>
		<!-- /.container -->
	</div>
	<!-- /.intro-header -->

{{template "footer"}}
{{template "bootstrapjs"}}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.js"></script>
<script>
var linklistsort = Sortable.create(linklist, {
  multiDrag: true,
  selectedClass: 'selected',
  handle: ".handle",
  animation: 150,
  store: {
    set: function (linklistsort) {
      const order = linklistsort.toArray();
      // console.log(order, "order")
      xhr = new XMLHttpRequest();
      xhr.open('POST', "/api/v1/draw/{{.ID}}/order");
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onload = function() {
        const res = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
	  i = 1;
	  order.forEach(function(link) {
            const el = document.getElementById("throworder-" + link);
	    el.innerHTML = i;
	    i++;
	  });
        } else {
	    alert(xhr.responseText)
	}
      }
      xhr.send(encodeURI('order=' + order));
    }
  }
});

var markerlistsort = Sortable.create(markerlist, {
  multiDrag: true,
  selectedClass: 'selected',
  handle: ".handle",
  animation: 150,
  store: {
    set: function (markerlistsort) {
      var order = markerlistsort.toArray();
      xhr = new XMLHttpRequest();
      xhr.open('POST', "/api/v1/draw/{{.ID}}/markerorder");
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onload = function() {
        var res = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
	  i = 1;
	  order.forEach(function(marker) {
	    const el = document.getElementById("markerorder-" + marker);
	    el.innerHTML = i;
	    i++;
	  });
        } else {
	    alert(xhr.responseText)
	}
      }
      xhr.send(encodeURI('order=' + order));
    }
  }
});

function agentAssignLink(id, sel)
{
    sel.style.backgroundColor = "yellow";
    sel.setAttribute("disabled","true");
    xhr = new XMLHttpRequest();
    xhr.open('POST', "/api/v1/draw/{{.ID}}/link/" + id + "/assign");
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        var res = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
		sleep(100).then(function() {
	        sel.style.backgroundColor = "green"
	        sleep(500).then(function() {
	            sel.style.backgroundColor = "white"
	            sel.removeAttribute("disabled");
	        });
	    });
        } else {
	    alert(xhr.responseText)
	}
    }
    xhr.send(encodeURI('agent=' + sel.value));
}

function colorAssignLink(id, sel)
{
    sel.style.backgroundColor = "yellow";
    sel.setAttribute("disabled","true");
    xhr = new XMLHttpRequest();
    xhr.open('POST', "/api/v1/draw/{{.ID}}/link/" + id + "/color");
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        var res = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
		sleep(100).then(function() {
	        sel.style.backgroundColor = "green"
	        sleep(500).then(function() {
	            sel.style.backgroundColor = "white"
	            sel.removeAttribute("disabled");
	        });
	    });
        } else {
	    alert(xhr.responseText)
	}
    }
    xhr.send(encodeURI('color=' + sel.value));
}

function agentAssignMarker(id, sel)
{
    sel.style.backgroundColor = "yellow";
    sel.setAttribute("disabled","true");
    xhr = new XMLHttpRequest();
    xhr.open('POST', "/api/v1/draw/{{.ID}}/marker/" + id + "/assign");
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        var res = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
		sleep(100).then(function() {
	        sel.style.backgroundColor = "green"
	        sleep(500).then(function() {
	            sel.style.backgroundColor = "white"
	            sel.removeAttribute("disabled");
	        });
	    });
	} else {
	    alert(xhr.responseText)
	}
    }
    xhr.send(encodeURI('agent=' + sel.value));
}

function assignLinkDesc(id, sel)
{
    sel.style.backgroundColor = "yellow";
    sel.setAttribute("disabled","true");
    xhr = new XMLHttpRequest();
    xhr.open('POST', "/api/v1/draw/{{.ID}}/link/" + id + "/desc");
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        var res = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
		sleep(100).then(function() {
	        sel.style.backgroundColor = "green"
	        sleep(500).then(function() {
	            sel.style.backgroundColor = "white"
	            sel.removeAttribute("disabled");
	        });
	    });
	} else {
	    alert(xhr.responseText)
	}
    }
    xhr.send(encodeURI('desc=' + sel.value));
}

function changeLinkDirection(id, sel) {
    sel.style.backgroundColor = "yellow";
    sel.setAttribute("disabled","true");
    xhr = new XMLHttpRequest();
    xhr.open('GET', "/api/v1/draw/{{.ID}}/link/" + id + "/swap");
    // xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        var res = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
		sleep(100).then(function() {
	        sel.style.backgroundColor = "green"
	        sleep(500).then(function() {
	            sel.style.backgroundColor = "white"
	            sel.removeAttribute("disabled");
	        });
	    });
            const oldFm = document.getElementById("rev-" + id + "-fm").cloneNode(true);
            const oldTo = document.getElementById("rev-" + id + "-to").cloneNode(true);
            const fm = document.getElementById("rev-" + id + "-fm");
            const to = document.getElementById("rev-" + id + "-to");
	    fm.replaceChild(oldTo.firstChild, fm.firstChild);
	    to.replaceChild(oldFm.firstChild, to.firstChild);
            kn = document.getElementById("keysneeded");
	    kn.innerHTML = "Keys Needed <em>(refresh the page to update)</em>";
            cbl = document.getElementById("capsulebuildlist");
	    cbl.innerHTML = "Capsule Build List <em>(refresh the page to update)</em>";
	} else {
	    alert(xhr.responseText)
	}
    }
    xhr.send(encodeURI('desc=' + sel.value));
}

function assignMarkerComment(id, sel)
{
    sel.style.backgroundColor = "yellow";
    sel.setAttribute("disabled","true");
    xhr = new XMLHttpRequest();
    xhr.open('POST', "/api/v1/draw/{{.ID}}/marker/" + id + "/comment");
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        var res = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
		sleep(100).then(function() {
	        sel.style.backgroundColor = "green"
	        sleep(500).then(function() {
	            sel.style.backgroundColor = "white"
	            sel.removeAttribute("disabled");
	        });
	    });
	} else {
	    alert(xhr.responseText)
	}
    }
    xhr.send(encodeURI('comment=' + sel.value));
}

function setopinfo(id, sel)
{
    sel.style.backgroundColor = "yellow";
    sel.setAttribute("disabled","true");
    xhr = new XMLHttpRequest();
    xhr.open('POST', "/api/v1/draw/{{.ID}}/info");
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        var res = JSON.parse(xhr.responseText);
        if (xhr.status === 200) {
		sleep(100).then(function() {
	        sel.style.backgroundColor = "green"
	        sleep(500).then(function() {
	            sel.style.backgroundColor = "white"
	            sel.removeAttribute("disabled");
	        });
	    });
	} else {
	    alert(xhr.responseText)
	}
    }
    xhr.send(encodeURI('info=' + sel.value));
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
</script>
</body>
</html>
{{end}}
